@{
    ViewBag.Title = "StartThread";
}


<p>
    start a thread
</p>

<p>
    <span class="error"></span>
</p>

<p>
    with who? enter their handle guid, enter 1 if for everyone, enter yours for just you
    <input type="text" id="handle" name="handle" maxlength=255 value="1" />
</p>

<input type="button" id="start" name="start" value="start" />

<p>
    <span id="thread_result"></span>
</p>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {

            $("#start").click(function () {

                $("#start").fadeOut('fast');
                var to_handle = $("#handle").val();

                // guid code from http://stackoverflow.com/a/2117523/146516
                var group_key = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });

                if (to_handle.length == 0) {
                    $("span.error").html("please type a handle.").fadeIn();
                    $("#start").fadeIn('fast');
                    return;
                }
                var thread = { id: 1, fromHandleId: "@User.Identity.Name", toHandleId: to_handle, groupKey: group_key  };

                // Send the data using post
                var posting = $.post("@Url.Content("/api/thread")", thread);

                // Put the results in a div
                posting.done(function (data) {

                    // if active=1, then they have successfully registered a handle and logged in
                    // if active=-1, then the username was taken
                    // if active=-1, then there was an error
                    console.log(data);

                    switch (data.result) {
                        case 0:
                            $("#start").fadeIn('fast');
                            $("span.error").html("there was an error starting the thread.").fadeIn();
                            break;
                        case 1:
                            // redirect home..
                            window.location = "@Url.Content("~/")";
                            break;
                    }

                });

                posting.error(function () {
                    $("#start").fadeIn('fast');
                    $("span.error").html("there was an error starting the thread.").fadeIn();
                });

            });
        });
    </script>
}
