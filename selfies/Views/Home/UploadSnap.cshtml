@{
    ViewBag.Title = "UploadSnap";
}

<form enctype="multipart/form-data">
    <input name="file" type="file" />
    <input type="button" value="Upload" />
    <input type="hidden" name="groupKey" id="groupKey" value="@ViewBag.guid" />
</form>
<progress></progress>


@section Scripts {

    <script>
        $(document).ready(function () {

            $(':file').change(function () {
                var file = this.files[0];
                var name = file.name;
                var size = file.size;
                var type = file.type;
                //Your validation
                console.log(file);
            });


            $(':button').click(function () {
                var formData = new FormData($('form')[0]);
                var group_key = "@ViewBag.guid".substring(0, 7);

                $.ajax({
                    url: '@Url.Content("~/api/upload/postfile")?key=' + group_key,  //Server script to process data
                    type: 'POST',
                    xhr: function () {  // Custom XMLHttpRequest
                        var myXhr = $.ajaxSettings.xhr();
                        if (myXhr.upload) { // Check if upload property exists
                            myXhr.upload.addEventListener('progress', progressHandlingFunction, false); // For handling the progress of the upload
                        }
                        return myXhr;
                    },
                    //Ajax events
                    //beforeSend: beforeSendHandler,
                    success: function (data) {

                        // redirect to details page... so dirty again

                        window.location = "@Url.Content("~/" + ViewBag.handle.name + "/")" + group_key;

                    },
                    error: function(err) {
                        alert("error :(");
                        console.log(err);
                    },
                    // Form data
                    data: formData,
                    //Options to tell jQuery not to process data or worry about content-type.
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });

            function progressHandlingFunction(e) {
                if (e.lengthComputable) {
                    $('progress').attr({ value: e.loaded, max: e.total });
                }
            }

        });

    </script>

}
